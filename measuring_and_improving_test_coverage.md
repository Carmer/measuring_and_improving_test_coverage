# Measuring and Improving Test Coverage

Objective: Give students guidelines to identify
whether their code is adequately tested, and tools
to get this information.

Takeaways: Ability to use SimpleCov to identify
untested code, and interpret that.


## What is code coverage?

Code coverage is the measure of how many lines of code
are executed by your test suite. You should strive for 100%
But there's always tradeoff, and often times, the effort
to actually hit 100%, makes it not worth getting that last little bit.

Example: Check out roster/bin/generate-groups, that code does not get hit by tests.


## What code coverage is not

Being purely "did this line get hit?" it does not show that
the line was hit meaningfully. You still need to think about your tests.
It is a *supplementary* tool, it doesn't compensate for your brain.


## What it looks like for a given method

Look at normalize_name_example/coverage/index.html#963e4d415d27bf7105ba9b10bc574da8e92d4515

* We can see that 'John Doe' did not get evaluated
* The conditional did, but it skipped over it
* the `if name` got evaluated twice, so we can infer 2 tests
* the `name` got evaluated once, so one test must have gone down that path
* the `Jane Doe` got evaluated once, so the other test must have gone down that path
* The 85.71% came from 6 lines evaluated / 7 lines total = 0.8571

From this, we can see we should add a test for a gender masculine person without a name.

But we can't see that we should consider adding a test for when none of the conditions hit.
That's up to our brains interpreting the data.


## SimpleCov

### What is it

[SimpleCov](https://github.com/colszowka/simplecov/) is a tool that records
which lines of code were executed while a program is running. It then generates
a report so that the developer can look at it and infer information about
what code is active/dead, or in our case, how much of our code the test
suite covers.

### Try it out

First, install simplecov with `gem install simplecov`.
Remember that if you're using Bundler, you'll need to add it to your Gemfile.

Now, check out speeding_ticket_example/speeding_ticket_test.rb
Think about which lines you expect to get covered in speeding_ticket_example/speeding_ticket.rb
Now run the test `ruby speeding_ticket_test.rb` to generate the report.
Notice the "Coverage report generated..." message at the bottom of the output.
Open the coverage report `open coverage/index.html`, notice it tells you some information
on this page, including the filename and its percentage covered.
Now click the filename, "speeding_ticket.rb", to see the report.
Was your guess correct?

### How it works

We start it at the appropriate time, ourselves, which lets it start recording.
We do this with the code:

```ruby
require 'simplecov'
SimpleCov.start
```

It then uses Ruby's [Coverage API](http://rdoc.info/stdlib/coverage/Coverage) to identify which lines were executed.

When we finish running, Simplecov hooks into Ruby's exit event (https://github.com/colszowka/simplecov/blob/fee9dcf1f990a57503b0d518d9844a7209db4734/lib/simplecov/defaults.rb#L42)
and writes the data it recorded, to an html file we can run in our browser to see the results.

We can see the data that it generated by looking at coverage/.resultset.json

```json
{
  "MiniTest": {
    "timestamp": 1407851307,
    "coverage": {
      "/Users/josh/deleteme/code-coverage/normalize_name_example/normalize_name.rb": [
        1,
        2,
        1,
        1,
        0,
        1,
        1,
        null,
        null
      ]
    }
  }
}
```

SimpleCov takes this information and matches it up to the source file,
adding the coverage information to each line and displaying them
in a static html page.

### When to load it

SimpleCov cannot see files that were loaded before it started.
This means that it needs to be the first thing required (it ignores files required before its definition)
Typically, we would put it in a test helper file, and have every test file
require the helper first.

### Where is the report?

The report that SimpleCov generates is in the "coverage" folder.
You can view it by looking at "index.html" in that folder.

### Where are the docs?

Documentation is on the [github page](https://github.com/colszowka/simplecov/).
Look here if your needs are more complex than what we covered.
There is information about how files are filtered (ie filter additional files/folders),
omitting code from the report, declaring profiles (you get a default one that
scopes the report to only code in your project root, but it also sees code
that is executed in gems and Ruby Core and more)! It shows you how you can
have it fail the running program if your code coverage doesn't hit some minimum
threshold (e.g. 90%).

### What about when it gets all messed up?

Sometimes, while trying to aggregate results (e.g. if you have more than one test suite)
it can get messed up. When this happens `rm -r coverage` and run again.

## Questions:

* We've talked about what it means if a line is not executed.
  But what might we conclude if a line gets hit a whole bunch of times?
* Should you put your coverage directory in git?
* Lets take a look at roster. Notice it's not hooked up to SimpleCov
  How should we do that? Lets do it together!

## How seriously should you take this?

Not **too** seriously. It's just a metric you can use to get some information,
it doesn't define what good coverage is, as you saw, we still need to use our brains.
In the end, you need to make the right decision for your project based on the context
that you have, and this is one way to get information about the context.

## Your turn!

Open up a project that you ran recently. Preferably one where you wrote the tests yoruself.
Go ahead and add SimpleCov, I'll be here if it goes awry :)
